name: Auto-update OpenCode version

on:
  schedule:
    # Check for updates every hour
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-update:
    runs-on: ubuntu-latest
    outputs:
      has_update: ${{ steps.check.outputs.has_update }}
      new_version: ${{ steps.check.outputs.new_version }}
    steps:
      - uses: actions/checkout@v6

      - name: Get current version
        id: current
        run: |
          version=$(grep 'version = "' package.nix | head -1 | sed 's/.*version = "\(.*\)";/\1/')
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Get latest GitHub release
        id: latest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          version=$(gh api repos/anomalyco/opencode/releases/latest --jq '.tag_name // empty' | sed 's/^v//')
          if [ -z "$version" ]; then
            echo "::error::Failed to fetch latest version from GitHub"
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Compare versions
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" != "${{ steps.latest.outputs.version }}" ]; then
            echo "has_update=true" >> "$GITHUB_OUTPUT"
            echo "new_version=${{ steps.latest.outputs.version }}" >> "$GITHUB_OUTPUT"
            echo "Update available: ${{ steps.current.outputs.version }} -> ${{ steps.latest.outputs.version }}"
          else
            echo "has_update=false" >> "$GITHUB_OUTPUT"
            echo "Already up to date: ${{ steps.current.outputs.version }}"
          fi

  update:
    needs: check-update
    if: needs.check-update.outputs.has_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - uses: cachix/install-nix-action@v31
        with:
          nix_path: nixpkgs=channel:nixpkgs-unstable

      - name: Update version
        run: ./scripts/update-version.sh --version "${{ needs.check-update.outputs.new_version }}"

      - name: Build and test
        run: |
          nix build
          ./result/bin/opencode --version

      - name: Create pull request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore(deps): bump opencode to v${{ needs.check-update.outputs.new_version }}"
          title: "chore(deps): bump opencode to v${{ needs.check-update.outputs.new_version }}"
          body: |
            Automated update of OpenCode to v${{ needs.check-update.outputs.new_version }}.

            Release: https://github.com/anomalyco/opencode/releases/tag/v${{ needs.check-update.outputs.new_version }}
          branch: chore/bump-opencode-v${{ needs.check-update.outputs.new_version }}
          delete-branch: true
          labels: automated

      - name: Enable auto-merge
        if: steps.create-pull-request.outputs.pull-request-number
        run: gh pr merge --auto --squash "${{ steps.create-pull-request.outputs.pull-request-number }}"
        env:
          GH_TOKEN: ${{ github.token }}
